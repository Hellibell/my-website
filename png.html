<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JPG → PNG โปร่งใส</title>
<style>
body {
  font-family: system-ui, -apple-system, Segoe UI, Roboto;
  display: flex; justify-content: center; padding: 40px;
  background: #0f172a; color: #e6eef8;
}
.card {
  background: #0b1220; padding: 20px; border-radius: 12px;
  box-shadow: 0 6px 18px rgba(0,0,0,.6); width: 360px;
}
input, textarea {
  width: 100%; padding: 10px; margin: 8px 0;
  border-radius: 8px; border: 1px solid #213047;
  background: #071022; color: inherit;
}
button {
  padding: 10px 14px; border-radius: 8px; border: 0;
  background: #7c3aed; color: white; cursor: pointer;
}
button.gray { background:#334155 }
.qr-wrap { display:flex; flex-direction:column; align-items:center; gap:10px; margin-top:8px }
img { max-width: 300px; border:1px solid #213047; border-radius: 8px; }
</style>
</head>
<body>
<div class="card">
<h2 style="text-align:center;">แปลง JPG → PNG โปร่งใส</h2>

<input type="file" id="fileInput" accept="image/jpeg">
<button id="convertBtn">แปลงและลบพื้นหลัง</button>

<div class="qr-wrap">
  <a id="downloadLink" style="display:none;">ดาวน์โหลด PNG</a>
  <img id="preview">
</div>

<canvas id="canvas" style="display:none;"></canvas>
</div>

<script>
// flood-fill เพื่อลบพื้นหลังสีขาว
function floodFillTransparent(ctx, x, y, targetColor) {
  const canvasWidth = ctx.canvas.width;
  const canvasHeight = ctx.canvas.height;
  const imageData = ctx.getImageData(0,0,canvasWidth,canvasHeight);
  const data = imageData.data;

  function colorMatch(i) {
    return data[i] === targetColor[0] &&
           data[i+1] === targetColor[1] &&
           data[i+2] === targetColor[2];
  }

  const stack = [[x,y]];
  while(stack.length) {
    const [cx, cy] = stack.pop();
    if(cx<0||cy<0||cx>=canvasWidth||cy>=canvasHeight) continue;
    const i = (cy*canvasWidth + cx)*4;
    if(!colorMatch(i) || data[i+3]===0) continue;

    data[i+3] = 0; // ทำโปร่งใส

    stack.push([cx+1, cy]);
    stack.push([cx-1, cy]);
    stack.push([cx, cy+1]);
    stack.push([cx, cy-1]);
  }

  ctx.putImageData(imageData,0,0);
}

const fileInput = document.getElementById('fileInput');
const convertBtn = document.getElementById('convertBtn');
const canvas = document.getElementById('canvas');
const downloadLink = document.getElementById('downloadLink');
const preview = document.getElementById('preview');

convertBtn.addEventListener('click', () => {
  const file = fileInput.files[0];
  if (!file) {
    alert('กรุณาเลือกไฟล์ JPG ก่อน');
    return;
  }

  const img = new Image();
  img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0);

    // ดึงสี pixel มุมบนซ้ายเป็นพื้นหลัง
    const topLeft = ctx.getImageData(0,0,1,1).data;
    const bgColor = [topLeft[0], topLeft[1], topLeft[2]];

    // flood-fill จาก 4 มุม
    floodFillTransparent(ctx, 0,0,bgColor);
    floodFillTransparent(ctx, img.width-1,0,bgColor);
    floodFillTransparent(ctx, 0,img.height-1,bgColor);
    floodFillTransparent(ctx, img.width-1,img.height-1,bgColor);

    const pngData = canvas.toDataURL('image/png');
    preview.src = pngData;
    downloadLink.href = pngData;
    downloadLink.download = 'converted.png';
    downloadLink.style.display = 'inline';
    downloadLink.textContent = 'ดาวน์โหลด PNG';
  };

  img.src = URL.createObjectURL(file);
});
</script>
</body>
</html>
